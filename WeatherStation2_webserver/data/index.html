<!DOCTYPE html>
<html>
    <head>
        <title>WeatherStation</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
        <link rel="stylesheet" href="css/bootstrap.min.css">
        <link rel="stylesheet" href="css/responsive-tiles.css?1221">
        <link rel="stylesheet" href="css/weather-icons.min.css?21">
        <script type="text/javascript" src="jscript/suncalc.js"></script>
        <script>
            var date, hours, minutes, seconds;
			var times;
			
			window.setInterval("update()", 10000); 

            function formatLeadingZero(i) {
				return i < 10 ? "0" + i : i;
			}
			function DisplayCurrentTime() {
                  date = new Date();
                  hours = formatLeadingZero(date.getHours());
                  minutes = formatLeadingZero(date.getMinutes());
                  seconds = formatLeadingZero(date.getSeconds());
                  var currentTime = document.getElementById("currentTime").innerHTML = hours + ":" + minutes + ":" + seconds;
            };            
            function update(){      
                var xhr=new XMLHttpRequest();      
                xhr.open("GET", "/json", true);      
                xhr.onreadystatechange = function () {        
                    if (xhr.readyState != XMLHttpRequest.DONE || xhr.status != 200) 
                        return;        
                    var getData = JSON.parse(xhr.responseText);        
                    document.getElementById('BMP').innerHTML=getData.BMP.toFixed(1);        
                    document.getElementById('BMT').innerHTML=getData.BMT.toFixed(1);        
                    document.getElementById('BMH').innerHTML=getData.BMH.toFixed(1);        
                    document.getElementById('Temp').innerHTML=getData.Temp.toFixed(1);        
                    document.getElementById('Hum').innerHTML=getData.Hum.toFixed(1);        
                    document.getElementById('OW1').innerHTML=getData.OW1.toFixed(1);        
                    document.getElementById('OBJ').innerHTML=getData.OBJ.toFixed(1);
                    document.getElementById('AMB').innerHTML=getData.AMB.toFixed(1);        
                    document.getElementById('BHV').innerHTML=getData.BHV.toFixed(1);        
                    document.getElementById('RT').innerHTML=getData.RT;      
                    document.getElementById('VER').innerHTML=getData.Ver;
                    document.getElementById('VED').innerHTML=getData.VDate;
					DisplayCurrentTime();
					DisplayCloudIDX((getData.OW1 - getData.OBJ));
                };      
                xhr.send();
            }
            function AstroData() {
                times = SunCalc.getTimes(new Date(), 43.93, 39.93);
                
                document.getElementById('sunrise').innerHTML = formatLeadingZero(times.sunrise.getHours()) + ':' + formatLeadingZero(times.sunrise.getMinutes());
                document.getElementById('sunset').innerHTML = formatLeadingZero(times.sunset.getHours()) + ':' + formatLeadingZero(times.sunset.getMinutes());

                document.getElementById('civiltwilightend').innerHTML = formatLeadingZero(times.dusk.getHours()) + ':' + formatLeadingZero(times.dusk.getMinutes());
                document.getElementById('nauttwilightend').innerHTML = formatLeadingZero(times.nauticalDusk.getHours()) + ':' + formatLeadingZero(times.nauticalDusk.getMinutes());
                document.getElementById('astrotwilightend').innerHTML = formatLeadingZero(times.night.getHours()) + ':' + formatLeadingZero(times.night.getMinutes());

                document.getElementById('civiltwilightstart').innerHTML =	formatLeadingZero(times.dawn.getHours()) + ':' + formatLeadingZero(times.dawn.getMinutes());
                document.getElementById('nauttwilightstart').innerHTML = 	formatLeadingZero(times.nauticalDawn.getHours()) + ':' + formatLeadingZero(times.nauticalDawn.getMinutes());
                document.getElementById('astrotwilightstart').innerHTML = 	formatLeadingZero(times.nightEnd.getHours()) + ':' + formatLeadingZero(times.nightEnd.getMinutes());
                
                var moonphase = SunCalc.getMoonIllumination(new Date());
                var moonico=""; 
                var moonphaseconst=0.035714;
                var moonicoid = 0; 
                if (moonphase.phase <       0.250) {
                    moonicoid = (( moonphase.phase / moonphaseconst ) | 0); 
                    if (moonphase.phase <       0.0357) moonico = "wi-moon-alt-new";
                    else moonico = "wi-moon-alt-waxing-crescent-" + moonicoid; 
                }else if (moonphase.phase < 0.5) {
                    moonicoid = (( (moonphase.phase - 0.25) / moonphaseconst ) | 0); 
                    if (moonphase.phase <       0.2857) moonico = "wi-moon-alt-first-quarter";
                    else moonico = "wi-moon-alt-waxing-gibbous-" + moonicoid; 
                }else if (moonphase.phase < 0.75) {
                    moonicoid = (( (moonphase.phase - 0.5) / moonphaseconst ) | 0); 
                    if (moonphase.phase <       0.5357) moonico = "wi-moon-alt-full";
                    else moonico = "wi-moon-alt-waxing-gibbous-" + moonicoid; 
                }else {
                    moonicoid = (( (moonphase.phase - 0.75) / moonphaseconst ) | 0); 
                    if (moonphase.phase <       0,7857) moonico = "wi-moon-alt-third-quarter";
                    else moonico = "wi-moon-alt-waning-crescent-" + moonicoid; 
                }
                
                document.getElementById("moonphaseicon").className = "wi wi-4x " + moonico;
                document.getElementById('moonphase').innerHTML = moonphase.phase.toLocaleString(  undefined, { minimumFractionDigits: 2 }) ; // leave undefined to use the browser's locale, r use a string like 'en-US' to override it.
                
                var moontimes = SunCalc.getMoonTimes(new Date(), 43.93, 39.93);
                document.getElementById('moonrise').innerHTML = moontimes.rise.getHours() + ':' + moontimes.rise.getMinutes();
                document.getElementById('moonset').innerHTML = moontimes.set.getHours() + ':' + moontimes.set.getMinutes();

            }
			function DisplayCloudIDX(CIDX) {
				var cloudico = "wi-cloudy";
				if (date.getHours() >= times.sunset.getHours() || date.getHours() <= times.sunrise.getHours()) {
					//alert("night: "+date.getHours() + "(" + times.sunset.getHours() + ")");
					if (CIDX > 7)
						cloudico = "wi-stars";
					else if (CIDX > 4)
						cloudico = "wi-night-alt-partly-cloudy";
					
				} else {
					//alert("day: "+date.getHours() + "(" + times.sunset.getHours() + ")");
					if (CIDX > 7)
						cloudico = "wi-day-sunny";
					else if (CIDX > 4)
						cloudico = "wi-day-cloudy";
				}
				document.getElementById("CIDX").className = "wi wi-4x " + cloudico;
				document.getElementById('CIDX').innerHTML=CIDX.toFixed(1);
			}
			function load(){
                update();
                AstroData();
            }
        </script>
    </head>
    <body onload="load()">
        <div class="container">
          <section class="cms-boxes">
            <div class="container-fluid">
            
                <div class="header-row">
                <div class="cms-boxes-outer">
                    <div class="cms-boxes-items">
                        <div class="boxes-align">
                            <div class="header-box">
                                <h2>Weather Station</h2>
                                <p><small>WEATHER STATION MkII v<span id="VER">2.0</span> [<span id="VED">20200822</span>]</small>.<bra>
                                <small>Last updated <span id="currentTime">0:00:00</span>, runtime <span id="RT">100</span> msec</small></p>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            
            
                <!-- 1st row -->
                <div class="row">
                <div class="col-md-4 cms-boxes-outer">
                  <div class="cms-boxes-items cms-temp">
                    <div class="boxes-align">
                      <div class="small-box">
                        <h2>Temperature</h2>
                        <i class="wi wi-thermometer wi-4x">&nbsp;</i><i class="wi wi-4x" id="OW1"><span class="wi wi-na normal-color"></span></i><i class="wi wi-celsius wi-2x">&nbsp;</i>
                        <p>Current temperature, measured by ds18b20 sensor</p>
                        Additional readings:
                        <table class="tcenter"  cellspacing="0" border="0" cellpadding="0" align="center">
                        <tr><td><span id="Temp">100</span><i class="wi wi-celsius">&nbsp;</i></</td><td class="tdcomment">by DHT22</td>
                        </tr>
                        <tr><td><span id="BMT">100</span><i class="wi wi-celsius">&nbsp;</i></td><td class="tdcomment">by BME280</td>
                        </tr>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-4 cms-boxes-outer">
                  <div class="cms-boxes-items cms-humidity">
                    <div class="boxes-align">
                      <div class="small-box">
                        <h2>Humidity</h2>
                        <i class="wi wi-humidity wi-4x">&nbsp;</i><i class="wi wi-4x" id="Hum"><span class="wi wi-na normal-color"></span></i><i class="wi wi-2x">&nbsp;%</i>
                        <h6><small>Current humidity, measured by DHT22 sensor</small></h6>
                        Additional readings:
                        <table class="tcenter"  cellspacing="0" border="0" cellpadding="0" align="center">
                        <tr><td><span id="BMH">0</span><i class="wi">%&nbsp;</i></td><td class="tdcomment">by BME280</td>
                        </tr>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-4 cms-boxes-outer">
                  <div class="cms-boxes-items cms-pressure">
                    <div class="boxes-align">
                      <div class="small-box">
                        <h2>Pressure</h2>
                        <i class="wi wi-barometer wi-4x">&nbsp;</i><i class="wi wi-4x" id="BMP"><span class="wi wi-na normal-color"></span></i><i class="wi wi-2x">&nbsp;mmHg</i>
                        <p>Current pressure, measured by BME280 sensor</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 2nd row -->
              <div class="row">
                <div class="col-md-4 cms-boxes-outer">
                  <div class="cms-boxes-items cms-mlx">
                    <div class="boxes-align">
                      <div class="small-box">
                        <h2>Cloud sensor</h2>
                        <i class="wi wi-cloudy wi-4x" id="CIDX">&nbsp;<span class="wi wi-na normal-color"></span></i>
                        <p>Measured by ML90614 sensor</p>
                        Additional data:
                        <table class="tcenter"  cellspacing="0" border="0" cellpadding="0" align="center">
                        <tr><td><span id="OBJ">100</span><i class="wi wi-celsius">&nbsp;</i></</td><td class="tdcomment">Object temp</td>
                        </tr>
                        <tr><td><span id="AMB">100</span><i class="wi wi-celsius">&nbsp;</i></td><td class="tdcomment">Ambient temp</td>
                        </tr>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-4 cms-boxes-outer">
                  <div class="cms-boxes-items cms-illum">
                    <div class="boxes-align">
                      <div class="small-box">
                        <h2>Illumination</h2>
                        <i class="wi wi-day-sunny wi-4x">&nbsp;</i><i class="wi wi-4x" id="BHV"><span class="wi wi-na normal-color"></span></i><i class="wi wi-2x">&nbsp;lux</i>
                        <p>Current illumination, measured by BH1750FVI sensor</p>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-4 cms-boxes-outer">
                  <div class="cms-boxes-items cms-wind">
                    <div class="boxes-align">
                      <div class="small-box">
                        <h2>Rain</h2>
                        <i class="wi wi-showers wi-4x">&nbsp;</i><i class="wi wi-4x" id="Rain"><span class="wi wi-na normal-color"></span></i>
                        <p>As reading by ceramic sensor</p>
                        Additional readings:
                        <table class="tcenter"  cellspacing="0" border="0" cellpadding="0" align="center">
                        <tr><td><span id="Rain2">0</span><i class="wi">%&nbsp;</i></td><td class="tdcomment">by classic rain sensor</td>
                        </tr>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              
              <!-- 3rd row -->
              <div class="row">
                <div class="col-md-4 cms-boxes-outersmall">
                  <div class="cms-boxes-items cms-astro">
                    <div class="boxes-align">
                      <div class="small-box">
                        <h2>Sun</h2>
                        <table class="tcenter"  cellspacing="0" border="0" cellpadding="0" align="center">
                        <tr><td><i class="wi wi-sunrise wi-2x">&nbsp;</i></td>
                        <td><span id="sunrise">0</span>&nbsp;</td>
                        </tr>
                        <tr><td><i class="wi wi-sunset wi-2x">&nbsp;</i></td>
                        <td><span id="sunset">0</span>&nbsp;</i></td>
                        </tr>
                        </table>
                        <p>
                        Civil twilight: ends <span id="civiltwilightend">20:55</span>/starts <span id="civiltwilightstart">5:15</span><br>
                        Nautial twilight: ends <span id="nauttwilightend">20:55</span>/starts <span id="nauttwilightstart">5:15</span><br>
                        Astronomical twilight: ends <span id="astrotwilightend">20:55</span>/starts <span id="astrotwilightstart">5:15</span></p>
                        
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-4 cms-boxes-outersmall">
                  <div class="cms-boxes-items cms-moon">
                    <div class="boxes-align">
                      <div class="small-box">
                        <h2>Moon</h2>
                        <table class="tcenter"  cellspacing="0" border="0" cellpadding="0" align="center">
                        <tr><td><i class="wi wi-moonrise wi-2x">&nbsp;</i></td>
                        <td><span id="moonrise">0:00</span>&nbsp;</td>
                        <td rowspan=2>&nbsp;<i id="moonphaseicon" class="wi wi-moon-alt-waning-gibbous-6 wi-4x">&nbsp;</i></td>
                        </tr>
                        <tr><td><i class="wi wi-moonset wi-2x">&nbsp;</i></td>
                        <td><span id="moonset">0:00</span>&nbsp;</td>
                        </tr>
                        </table>
                        <p>fraction: <span id="moonphase">0</span></p>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-4 cms-boxes-outersmall">
                  <div class="cms-boxes-items cms-misc">
                    <div class="boxes-align">
                      <div class="small-box">
                        <i class="wi wi-refresh wi-2x">&nbsp;Enter config mode</i>
                        
                        <p>Under construction</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </div>
    </body>
 </html>